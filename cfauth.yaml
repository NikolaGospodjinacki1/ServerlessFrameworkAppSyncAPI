AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  BucketNameParameter:
    Type: String
    Description: A legal bucket name.  Must not exist.
  PriceClass:
    Type: String
    Description: CloudFront price class, e.g. PriceClass_200 for most regions (default), PriceClass_All for all regions (the default), PriceClass_100 least expensive (US, Canada, Europe), or PriceClass_All
    Default: PriceClass_200
  SemanticVersion:
    Type: String
    Description: Semantic version of the back end
    Default: 2.1.5
  HttpHeaders:
    Type: String
    Description: The HTTP headers to set on all responses from CloudFront. Defaults are illustrations only and contain a report-only Cloud Security Policy -- adjust for your application
    Default: "{\n  \"Content-Security-Policy-Report-Only\": \"default-src 'none'; img-src 'self'; script-src 'self'; style-src 'self'; object-src 'none'; connect-src 'self' https://*.amazonaws.com https://*.amazoncognito.com\"\
      ,\n  \"Strict-Transport-Security\": \"max-age=31536000; includeSubdomains; preload\",\n  \"Referrer-Policy\": \"same-origin\",\n  \"X-XSS-Protection\": \"1; mode=block\",\n  \"X-Frame-Options\": \"\
      DENY\",\n  \"X-Content-Type-Options\": \"nosniff\"\n}"
Resources:
  ApplicationBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref 'BucketNameParameter'
  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub '${BucketNameParameter}-OAI'
  S3AccessPolicyForOAI:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref 'ApplicationBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              CanonicalUser: !GetAtt 'CloudFrontOriginAccessIdentity.S3CanonicalUserId'
            Action: s3:GetObject
            Resource: !Sub '${ApplicationBucket.Arn}/*'
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        CacheBehaviors:
          - PathPattern: /parseauth
            Compress: true
            ForwardedValues:
              QueryString: true
            LambdaFunctionAssociations:
              - EventType: viewer-request
                LambdaFunctionARN: !GetAtt 'LambdaEdgeProtection.Outputs.ParseAuthHandler'
            TargetOriginId: dummy-origin
            ViewerProtocolPolicy: redirect-to-https
          - PathPattern: /refreshauth
            Compress: true
            ForwardedValues:
              QueryString: true
            LambdaFunctionAssociations:
              - EventType: viewer-request
                LambdaFunctionARN: !GetAtt 'LambdaEdgeProtection.Outputs.RefreshAuthHandler'
            TargetOriginId: dummy-origin
            ViewerProtocolPolicy: redirect-to-https
          - PathPattern: /signout
            Compress: true
            ForwardedValues:
              QueryString: true
            LambdaFunctionAssociations:
              - EventType: viewer-request
                LambdaFunctionARN: !GetAtt 'LambdaEdgeProtection.Outputs.SignOutHandler'
            TargetOriginId: dummy-origin
            ViewerProtocolPolicy: redirect-to-https
        DefaultCacheBehavior:
          Compress: true
          ForwardedValues:
            QueryString: true
          LambdaFunctionAssociations:
            - EventType: viewer-request
              LambdaFunctionARN: !GetAtt 'LambdaEdgeProtection.Outputs.CheckAuthHandler'
            - EventType: origin-response
              LambdaFunctionARN: !GetAtt 'LambdaEdgeProtection.Outputs.HttpHeadersHandler'
          TargetOriginId: protected-origin
          ViewerProtocolPolicy: redirect-to-https
        Enabled: true
        Origins:
          - DomainName: example.org
            Id: dummy-origin
            CustomOriginConfig:
              OriginProtocolPolicy: match-viewer
          - DomainName: !GetAtt 'ApplicationBucket.RegionalDomainName'
            Id: protected-origin
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}'
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
        PriceClass: !Ref 'PriceClass'
        DefaultRootObject: index.html
  LambdaEdgeProtection:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: >-
        https://awsserverlessrepo-changesets-plntc6bfnfj.s3.amazonaws.com/802288441694/arn%3Aaws%3Aserverlessrepo%3Aus-east-1%3A520945424137%3Aapplications-cloudfront-authorization-at-edge-versions-2.1.5/87f0cf57-e58d-4293-8da3-e87dd8450333.yaml?X-Amz-Security-Token=IQoJb3JpZ2luX2VjEA4aCXVzLWVhc3QtMSJHMEUCIHznrfW80wlLeHmrJjaJw8Joh8Vpw7PQS5TrdeRKyFrLAiEAscZY3ybCC%2FTFiQpoS1eGrijXMguQvdvSELTYd37V%2FToqsAMI5%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwNjYyNDI0Njg2NTQiDF%2BwfqfTQucUeSlfVCqEAx%2FCDohzzmKUkZv4o5wnIhbn760fcnUmmqYFx1kiR2fLAjmyKyNClNrErYLqIxlhFYFXKZlVdnDByZNKAd%2FQRuihJOEXk8p2hZHMmtM%2F8FyhQysrDq%2FakQd4Kbk9wIPfV5wUI2IbWIfs2EZ8vbsd4q0YFE58JV7NZqSNqcmhWRUVaXCkoGJfEzJKK9jZXAcaT6wrJ4e8Ps78O%2FcxgKpWSPCy20nb2dUAUszgkTb%2BowBo4Cq54CrsX8mVZvCfLWdntYDIYDydMmcB%2B0aLyA%2BVBnt5AEGBGq9Owg4GrZR6CnL0wCu9bcmt011b2Di51diKf2pf74cuIfK2gYvO8ipFM7xymC5x8K0W4MJbcVOBCMRvPIrdnNogvkUT1st3NhGuEZo5iQau%2B5QVk0lQpwurIC%2BcnhEBcy7ZYjOBg%2FtLFzscugU0HAPwXjL2Gvrfb3GpqfHNKCrmsrHgLMWMXv7kmfSJpeWk2Gb6RHb89jqle%2Fvai%2FtFTX7mSnEoLcR39XjBeIY0z%2FMw%2BY%2FjmgY6nQHBiQpwRbyP8diuoWb2Z8lPTJE0sZYSs1adTvV8Lea7aWvN0RFsxNXBVe33Dx4rn1hiB4VlLb1SMkIwUmY6qLGRUKq9q3jeTUOYj0lh%2BinRpUb1USZ1eIQir07McX3Rh6Dd1cwK8aR2cCnBKwb%2BibqBabBuAumZ3Gn5qt6kynEPMKOVBWRyumOHt39U02A14XMPSZ4fCRea9NAjj10R&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20221026T072937Z&X-Amz-SignedHeaders=host&X-Amz-Expires=21600&X-Amz-Credential=ASIAQ63C33MXL3XUX27E%2F20221026%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Signature=5a3ea28fe1f104ab61d8a98b5434f45a25d87a1574359edfdbb2519049e7c843
      Parameters:
        CreateCloudFrontDistribution: 'false'
        HttpHeaders: !Ref 'HttpHeaders'
      Tags:
        - Key: lambda:createdBy
          Value: SAM
        - Key: serverlessrepo:applicationId
          Value: arn:aws:serverlessrepo:us-east-1:520945424137:applications/cloudfront-authorization-at-edge
        - Key: serverlessrepo:semanticVersion
          Value: 2.1.5

